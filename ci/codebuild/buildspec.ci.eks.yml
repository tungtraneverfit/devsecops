version: 0.2

phases:
  install:
    commands:
      # Install tools
      - uname -m
      - yum update -y
      - export SONAR_SCANNER_VERSION=6.2.1.4610
      - export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux-x64
      - curl --create-dirs -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux-x64.zip
      - unzip -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
      - export PATH=$SONAR_SCANNER_HOME/bin:$PATH
      - export SONAR_SCANNER_OPTS="-server"
      # - yum install zip bash gettext jq wget -y
      # Install docker-compose
      - docker --version
      - docker-compose version
      # Launch docker daemon
      - /usr/local/bin/dockerd --host=unix:///var/run/docker.sock --host=tcp://127.0.0.1:2375 --storage-driver=overlay2 &>/var/log/docker.log &
      - timeout 15 sh -c "until docker info; do echo .; sleep 1; done"
      - npm install -g snyk
      - npm install -g snyk-to-html

  pre_build:
    commands:
      - echo "this is pre build"

  build:
    commands:
      # - echo "Running SonarCloud Analysis"
      # - sonar-scanner -Dsonar.projectKey=quangtung-organization_devsecops -Dsonar.organization=quangtung-organization -Dsonar.host.url=https://sonarcloud.io -Dsonar.branch.name=develop -Dsonar.token=dc4f1bb5fb84d870d60424afa23499aa8bf14eb7
      - snyk auth d64b286a-4cf5-43b5-acbc-3b43938d5c02
      - snyk test --all-projects || true
      - snyk monitor --all-projects
      # - export JWT_TOKEN=$(curl -s --location ${DAST_URL} --header 'x-app-type: web-coach' --header 'Content-Type: application/json' --data-raw '{"email":"${DAST_EMAIL}","password":"${DAST_PASSWORD}"}' | jq -r '.token')
      - |
        export JWT_TOKEN=$(curl -s --location "${DAST_URL}" \
          --header "x-app-type: web-coach" \
          --header "Content-Type: application/json" \
          --data-raw "{\"email\":\"${DAST_EMAIL}\",\"password\":\"${DAST_PASSWORD}\"}" \
          | jq -r '.token')

      - echo $JWT_TOKEN

      - |-
        apt-get update
        apt-get -y install wget
        apt-get -y install default-jdk
        wget https://github.com/zaproxy/zaproxy/releases/download/v2.14.0/ZAP_2.14.0_Linux.tar.gz
        tar -xvf ZAP_2.14.0_Linux.tar.gz
        cd ZAP_2.14.0
        ./zap.sh -cmd -quickurl $DAST_TARGET -quickprogress -quickout ../zap_report.html

  post_build:
    commands:
      - echo "this is post build"
